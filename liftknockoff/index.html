<!DOCTYPE html>

<html>
<head>
	<title>EMAI'S LIFT KNOCKOFF</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" charset="utf-8"/>
	<link rel="stylesheet" href="style.css" />
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEerJkvR6bTT6i9BDteyiIXJiNXKjh7JQ&libraries=geometry"></script>
	
	<script>
	//MINE passenger: qg9kB6z3
	//Vehicle: suFKyeZg
	var myUsername = "suFKyeZg";
	var lat = 0;
	var lng = 0;

	var map;

	var me = new google.maps.LatLng(lat, lng);

	var myOptions = {
		zoom: 13, // The larger the zoom number, the bigger the zoom
		center: me,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	
	var marker;
	var infowindow = new google.maps.InfoWindow();

	var rides;

	var them = new google.maps.LatLng(lat, lng);
	var markerThem = new Array();
	
	var markerWeiner;

	var distToThem;


	var myIcon = 
	{
	    url: "http://www.clker.com/cliparts/1/q/n/y/6/4/map-pin-purple-md.png", 
	    scaledSize: new google.maps.Size(25, 40)
	};

	var vehicleIcon = {
	    url: "https://tuftsdev.github.io/WebProgramming/assignments/car.png", 
	    scaledSize: new google.maps.Size(20, 45)
	};

	var passengerIcon = {
		url: "https://icons-for-free.com/free-icons/png/512/1011786.png",
		scaledSize: new google.maps.Size(40, 30)
	}

	var weinermobileIcon = {
	    url: "https://tuftsdev.github.io/WebProgramming/assignments/weinermobile.png", 
	    scaledSize: new google.maps.Size(40, 40)
	};

	

	var weinermobileExists = false;
	var distToWeiner;
	
	var closestRideDist = 99999; // vehicle or passenger


	function myMain() 
	{
		// initialize, create the map in the "map_canvas" <div>
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

		mapMe();

		mapThem();

	}

	function mapMe()
	{
		// get my location
		navigator.geolocation.getCurrentPosition(function(somePos) 
		{
		
			lat = somePos.coords.latitude;
			lng = somePos.coords.longitude;
			
			printLocation();

			me = new google.maps.LatLng(lat,lng);

			map.panTo(me); // update map and go there			

			marker = new google.maps.Marker({
				position: me,
				title: "Me (" + myUsername + ")",
				icon: myIcon

			});
			marker.setMap(map);

			// Open info window on click of marker
			google.maps.event.addListener(marker, 'click', function() {
				DisplayMyInfoWindow();
			});


		});
	}


	function printLocation() 
	{
		elem = document.getElementById("location");
		elem.innerHTML = '<p class="fun">' + lat + ", AND " + lng + "</p>";
	}

	
	function mapThem() 
	{
		// send my location information and retrieve info on passengers or vehicles
		rideRequest();
		
		// What to do when we get a response back
		request.onreadystatechange = function() 
		{
			// Parse the JSON data from response
			if (request.readyState == 4 && request.status == 200) 
			{
				data = request.responseText;
				console.log(data);

				responseArray = JSON.parse(data);

				
				
				if (responseArray.hasOwnProperty('vehicles') == true){
					rides = responseArray.vehicles;
				}
				else{
					rides = responseArray.passengers;
				}
	
				console.log(responseArray);
				console.log("LENGTH is " + rides.length);

				for (count = 0; count < rides.length; count++)
				{
					var theirLat = rides[count].lat
					var theirLng = rides[count].lng

					them = new google.maps.LatLng(theirLat,theirLng);

					if (rides[count].username == "WEINERMOBILE")
					{
						weinermobileExists = true;

						markerWeiner = new google.maps.Marker({
							position: them,
							map: map,
							title: "WEINERMOBILE! ",
							icon: weinermobileIcon
						});

						// convert distance from meters to miles
						distToWeiner = 0.000621371 * google.maps.geometry.spherical.computeDistanceBetween(me, them);
						console.log("DIST to weiner is" + distToWeiner);

						google.maps.event.addListener(markerWeiner, 'click', function () {

                            var name = markerWeiner.title;
                            var temp = distToWeiner;

                            infowindow.setContent(name + temp);
                            infowindow.open(map,this);

                        });

					}
					else // it's not a weinermobile
					{
						console.log("not a weinermobile " + count);



						// convert distance from meters to miles
						distToThem = 0.000621371 * google.maps.geometry.spherical.computeDistanceBetween(me, them);

						if (distToThem < closestRideDist)
						{
							console.log("CLOSER!!!");
							closestRideDist = distToThem;
						}



						if (responseArray.hasOwnProperty('vehicles') == true){
							markerThem[count] = new google.maps.Marker({
								position: them,
								map: map,
								title: '<div class="fun">Vehicle (' + rides[count].username + ')</div>' + distToThem + 'miles away from me',
								icon: vehicleIcon
							});

							console.log("is a vehicle " + count);

							//console.log(markerThem[count]);


							google.maps.event.addListener(markerThem[count], 'click', function() {
								
								console.log("LISTEN " + count);
								console.log(this);
								console.log(this.title);

								infowindow.setContent(this.title);
		                        infowindow.open(map,this);

						
		                    });

							
						}
						else{
							markerThem[count] = new google.maps.Marker({
								position: them,
								map: map,
								title: "Passenger (" + rides[count].username + ")",
								icon: passengerIcon
							});

							console.log(markerThem[count]);

							google.maps.event.addListener(markerThem[count], 'click', function() {
								console.log(markerThem[count]);

		                        var name = markerThem[count].title;


		                        var temp = distToThem;

		                        infowindow.setContent(name + temp);
		                        infowindow.open(map,this);
		                    });
							
						}

						




					}
			

				}
/*

				for (count = 0; count < rides.length; count++)
				{

					google.maps.event.addListener(markerThem[count], 'click', function () {
						console.log(markerThem[count]);

                        var name = markerThem[count].title;
                        var temp = distToThem;

                        infowindow.setContent(name + temp);
                        infowindow.open(map,this);
                    });

				}
				*/

				//markerThem.setMap(map);

				if (weinermobileExists == false)
				{
					distToWeiner = "IT DOES NOT EXIST!";
				}
/*
				// Open info window on click of marker
				google.maps.event.addListener(this, 'click', function() {
					DisplayMyInfoWindow();
				});

				*/

			}
		};
	
	}

	function rideRequest()
	{
		// Make an instance of XHR
		console.log("about to start xml request");
		request = new XMLHttpRequest();
		// Make request to the JSON source
		request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);
		
		request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
	
		navigator.geolocation.getCurrentPosition(function(somePos) 
		{
			// make sure lat and lng are retrieved before sending request
			lat = somePos.coords.latitude;
			lng = somePos.coords.longitude;

			myParameters = "username=" + myUsername + "&lat=" + lat + "&lng=" + lng

			//DELETE THIS LATER
			console.log("THE PARAMETERS IM SENDING ARE");
			console.log(myParameters);

			// Fire off request
		 	request.send(myParameters);

		});
	}

	function DisplayTheirInfoWindow()
	{
		theContent = '<div>ABCDEFDLJFSLKDFJ:DSKFSDF</div>';
		infowindow.setContent(theContent);
		//infowindow.open(map, markerThem, theContent);
		infowindow.open(map, this, theContent);

	}

	function DisplayMyInfoWindow()
	{
		// build content of infowindow
		var username = '<p class="fun">' + marker.title + '<br></p>';
		var weinerMessage;
		if (weinermobileExists == true){
			weinerMessage = '<div> The Weinermobile is ' + distToWeiner + ' miles away from me!<br></div>';
		}
		else{
			weinerMessage = '<div>The Weinermobile is nowhere to be seen</div>';
		}

		var closestVehicleMessage;
		if (closestRideDist == 99999){
			closestVehicleMessage = '<div>No vehicles.</div>';
		}
		else {
			closestVehicleMessage = '<div> Closest Vehicle: ' + closestRideDist + 'miles<br></div>'
		}

		// piece the content together
		var theContent = username + closestVehicleMessage + weinerMessage;

		//var theContent = '<h1 class="firstHeading">Uluru</h1>'+'<div id="bodyContent">'
		infowindow.setContent(theContent);
		infowindow.open(map, marker, theContent);
	}

	function DisplayVehicleInfoWindow()
	{
		// build content of infowindow
		var username = '<div class="fun">' + markerThem.title + '<br></div>';
		
/*
		var vehicleMessage;

		if (closestRideDist == 99999){
			closestVehicleMessage = '<div>No vehicles.</div>';
		}
		else {
			closestVehicleMessage = '<div> Closest Vehicle: ' + closestRideDist + 'miles<br></div>'
		}
*/
	
		var message = '<div> Distance away from me: ' + distToThem + ' miles<br></div>';

		// piece the content together
		var theContent = username + message;

		//var theContent = '<h1 class="firstHeading">Uluru</h1>'+'<div id="bodyContent">'
		infowindow.setContent(theContent);
		infowindow.open(map, markerThem, theContent);

	}




	</script>
</head>


<body onload="myMain()">
	<h1>Emai's Lift Knockoff Map</h1>
	<div id="location">Trying to determine location...</div>
	<div id="map_canvas"></div>


</body>





</html>

