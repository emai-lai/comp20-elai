<!-- HTML -->

<!DOCTYPE html>



<html>
<head>
	<title>Messages</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" charset="utf-8"/>
	<link rel="stylesheet" href="style.css" />


	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEerJkvR6bTT6i9BDteyiIXJiNXKjh7JQ"></script>
	

	<script>

	var lat = 0;
	var lng = 0;

	var me = new google.maps.LatLng(lat, lng);
	var myOptions = {
		zoom: 13, // The larger the zoom number, the bigger the zoom
		center: me,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var map;
	var marker;
	var infowindow = new google.maps.InfoWindow();


	var them = new google.maps.LatLng(lat, lng);
	var markerThem;




	

	function myMain() 
	{
		// initialize, create the map in the "map_canvas" <div>
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

		mapMe();

		mapThem();
		
	}

	function mapMe()
	{
		// get my location
		navigator.geolocation.getCurrentPosition(function(somePos) 
		{
			// DELETE THIS LATER
			console.log("I am here 2");
			lat = somePos.coords.latitude;
			lng = somePos.coords.longitude;
			
			printLocation();

			me = new google.maps.LatLng(lat,lng);
			map.panTo(me); // update map and go there

			//CHANGE ME LATER
			distanceToOther: 100;
			distanceToWeinermobile: 1000;

			marker = new google.maps.Marker({
				position: me,
				title: "You Are Here! "

			});
			marker.setMap(map);

			// Open info window on click of marker
			google.maps.event.addListener(marker, 'click', function() {
				infowindow.setContent(marker.title);
				infowindow.open(map, marker);
			});
		
		}
		);
	}

	function printLocation() 
	{
		console.log("I am here 4");
		elem = document.getElementById("location");
		elem.innerHTML = '<p class="fun">' + lat + ", AND " + lng + "</p>";
	}





	function mapThem() 
	{
		// Step 1: make an instance of XHR
		console.log("about to start xml request");
		request = new XMLHttpRequest();
		// Step 2: Make request to the JSON source
		request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);
		
		request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
		//request.setRequestHeader("Content-Type", "text/xml;charset=utf-8");

		console.log("THE PARAMETERS IM SENDING ARE");
		console.log("username=qg9kB6z3&lat=" + lat + "&lng=" + lng);
		myParameters = "username=qg9kB6z3&lat=" + lat + "&lng=" + lng

		// Step 4: Fire off request!!!
		request.send(myParameters);


		// Step 3: What to do when we get a response back
		request.onreadystatechange = function() 
		{
			// Step 5: parse the JSON data from response
			if (request.readyState == 4 && request.status == 200) 
			{
				data = request.responseText;
				console.log(data);

				vehiclesArray = JSON.parse(request.responseText);
	
				console.log(vehiclesArray);

				console.log(vehiclesArray.vehicles.length);
				


/*
				them = new google.maps.LatLng(42.40,-71.11);
		
				markerThem = new google.maps.Marker({
					position: them,
					title: "They Are Here! "
				});

				markerThem.setMap(map);
*/
				
    			//document.getElementById("demo").innerHTML = vehicles.name;
				console.log("ELEMENT 0 lat is");
				console.log(vehiclesArray.vehicles[0].lat);


				//var them;
				//var markerThem;
/*
				for (count = 0; count < vehiclesArray.vehicles.length; count++)
				{
					them[count] = new google.maps.LatLng(lat,lng);
				}
*/

	

				

				for (count = 0; count < vehiclesArray.vehicles.length; count++)
				{

					if (vehiclesArray.vehicles[count].username == "WEINERMOBILE")
					{
						console.log("WEINNNERMOBILEEEE");
					}




					var theirLat = vehiclesArray.vehicles[count].lat
					var theirLng = vehiclesArray.vehicles[count].lng
					console.log(theirLat + "AND" + theirLng);

					them = new google.maps.LatLng(theirLat,theirLng);

					markerThem = new google.maps.Marker({
						position: them,
						map: map,
						title: "They Are Here! "

					});


				    google.maps.event.addListener(markerThem, 'click', (function(markerThem, count) {
				        return function() {
				          infowindow.setContent(vehiclesArray.vehicles[count].username);
				          infowindow.open(map, markerThem);
				        }
				    })(markerThem, count));

			
					//map.panTo(them); //??
			



					markerThem.setMap(map);
				}
				//markerThem.setMap(map);

				/*
				// Open info window on click of marker
				google.maps.event.addListener(markerThem, 'click', function() {
					infowindow.setContent(markerThem.title);
					infowindow.open(map, markerThem);
				});*/
				

/*
				vehiclesSection = document.getElementById("vehicles");
				//messagesSection = document.getElementById("messages");

				vehiclesSection.innerHTML = "";
				for (count = 0 ; count < vehicles.length ; count++) 
				{
					vehiclesSection.innerHTML += "<p>" + vehicles[count].content + " from " + vehicles[count].username + "</p>";
				}
*/

			}
		};
	
	}

function mapThem2()
	{
		them = new google.maps.LatLng(42.40,-71.11);
		
		markerThem = new google.maps.Marker({
			position: them,
			title: "They Are Here! "
		});

		markerThem.setMap(map);

	}


	</script>
</head>


<body onload="myMain()">
	<h1>Where Am I</h1>
	<div id="location">Trying to determine location...</div>

	<div id="map_canvas"></div>


</body>





</html>

