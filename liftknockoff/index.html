<!-- HTML -->

<!DOCTYPE html>



<html>
<head>
	<title>EMAI'S LIFT KNOCKOFF</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" charset="utf-8"/>
	<link rel="stylesheet" href="style.css" />


	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEerJkvR6bTT6i9BDteyiIXJiNXKjh7JQ&libraries=geometry"></script>


	
	<script>

	var lat = 0;
	var lng = 0;

	var me = new google.maps.LatLng(lat, lng);
	var myOptions = {
		zoom: 13, // The larger the zoom number, the bigger the zoom
		center: me,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var map;
	var marker;
	var infowindow = new google.maps.InfoWindow();

	




	var them = new google.maps.LatLng(lat, lng);
	var markerThem;


	var myIcon = {
	    url: "http://www.clker.com/cliparts/1/q/n/y/6/4/map-pin-purple-md.png", 
	    scaledSize: new google.maps.Size(25, 40)
	};

	var vehicleIcon = {
	    url: "https://tuftsdev.github.io/WebProgramming/assignments/car.png", 
	    scaledSize: new google.maps.Size(20, 45)
	};

	var weinermobileIcon = {
	    url: "https://tuftsdev.github.io/WebProgramming/assignments/weinermobile.png", 
	    scaledSize: new google.maps.Size(40, 40)
	};

	
	var weinermobileExists = false;
	var distToWeiner;
	
	var closestThemDist = 99999; // vehicle or passenger


	function myMain() 
	{
		// initialize, create the map in the "map_canvas" <div>
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

		mapMe();

		mapThem();

	}

	function mapMe()
	{
		// get my location
		navigator.geolocation.getCurrentPosition(function(somePos) 
		{
		
			lat = somePos.coords.latitude;
			lng = somePos.coords.longitude;
			
			printLocation();

			me = new google.maps.LatLng(lat,lng);

	

			map.panTo(me); // update map and go there

			

			marker = new google.maps.Marker({
				position: me,
				title: "Me (qg9kB6z3)",

				icon: myIcon

			});
			marker.setMap(map);


			
			// Open info window on click of marker
			google.maps.event.addListener(marker, 'click', function() {
				
				// build content of infowindow
				var username = '<h1><strong>' + marker.title + '</strong><br></h1>';
				var part1 = '<div> Closest Weiner: ' + distToWeiner + 'miles<br></div>'
				var part2 = '<div> Closest Vehicle: ' + closestThemDist + 'miles<br></div>'


				var theContent = username + part1 + part2;
				//var theContent = '<h1 class="firstHeading">Uluru</h1>'+'<div id="bodyContent">'
				infowindow.setContent(theContent);
				infowindow.open(map, marker, theContent);


			});

		}
		);
	}

	function printLocation() 
	{
		console.log("I am here 4");
		elem = document.getElementById("location");
		elem.innerHTML = '<p class="fun">' + lat + ", AND " + lng + "</p>";
	}

	function mapThem() 
	{
		// Make an instance of XHR
		console.log("about to start xml request");
		request = new XMLHttpRequest();
		// Make request to the JSON source
		request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);
		
		request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
		//request.setRequestHeader("Content-Type", "text/xml;charset=utf-8");


		navigator.geolocation.getCurrentPosition(function(somePos) 
		{
			lat = somePos.coords.latitude;
			lng = somePos.coords.longitude;
			console.log("LAT" + lat);

			console.log("THE PARAMETERS IM SENDING ARE");
			console.log("username=qg9kB6z3&lat=" + lat + "&lng=" + lng);
			myParameters = "username=qg9kB6z3&lat=" + lat + "&lng=" + lng

			// Fire off request
		 	request.send(myParameters);

		});
		

		// What to do when we get a response back
		request.onreadystatechange = function() 
		{
			// Parse the JSON data from response
			if (request.readyState == 4 && request.status == 200) 
			{
				data = request.responseText;
				console.log(data);

				responseArray = JSON.parse(request.responseText);
	
				console.log(responseArray);
				console.log("LENGTH is " + responseArray.vehicles.length);

				
				
				for (count = 0; count < responseArray.vehicles.length; count++)
				{

					var theirLat = responseArray.vehicles[count].lat
					var theirLng = responseArray.vehicles[count].lng
					console.log(theirLat + "AND" + theirLng); // DELETE LATER

					them = new google.maps.LatLng(theirLat,theirLng);

					if (responseArray.vehicles[count].username == "WEINERMOBILE")
					{
						console.log("WEINNNERMOBILEEEE");
						weinermobileExists = true;

						markerThem = new google.maps.Marker({
							position: them,
							map: map,
							title: "They Are Here! ",
							icon: weinermobileIcon
						});

					
						// convert distance from meters to miles
						distToWeiner = 0.000621371 * google.maps.geometry.spherical.computeDistanceBetween(me, them);
						console.log("DIST to weiner is" + distToWeiner);




				
					}
					else // it's not a weinermobile
					{
						markerThem = new google.maps.Marker({
							position: them,
							map: map,
							title: "They Are Here! ",
							icon: vehicleIcon
						});

						// convert distance from meters to miles
						var distToThem = 0.000621371 * google.maps.geometry.spherical.computeDistanceBetween(me, them);
						console.log("DIST is" + distToThem);

						if (distToThem < closestThemDist)
						{
							console.log("CLOSER!!!");
							closestThemDist = distToThem;
						}
					}

					// Open info window on click of marker
				    google.maps.event.addListener(markerThem, 'click', (function(markerThem, count) {
				        return function() {
				          infowindow.setContent(responseArray.vehicles[count].username);
				         //infowindow.setContent(markerThem.title);
				          infowindow.open(map, markerThem);
				        }
				    })(markerThem, count));

			
					//map.panTo(them); //??
			
					markerThem.setMap(map);
				}
				//markerThem.setMap(map);



				if (weinermobileExists == false)
				{
					distToWeiner = "IT DOES NOT EXIST!";
				}




			}
		};
	
	}




	</script>
</head>


<body onload="myMain()">
	<h1>Lift Knockoff Map</h1>
	<div id="location">Trying to determine location...</div>

	<div id="map_canvas"></div>


</body>





</html>

